{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<section class="py-8">
    <h2 class="text-4xl font-bold text-center text-green-700 mb-10">Dashboard Penjualan</h2>

    {% if session['role'] == 'admin' %}
    <h3 class="text-2xl font-semibold text-gray-800 mb-6">Admin Overview</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
        <div class="bg-blue-50 p-6 rounded-lg shadow-md text-center">
            <h4 class="text-lg font-bold text-blue-700 mb-2">Total Pendapatan</h4>
            <p class="text-4xl font-extrabold text-blue-800">Rp {{ "{:,.0f}".format(total_revenue) }}</p>
        </div>
        <div class="bg-green-50 p-6 rounded-lg shadow-md text-center">
            <h4 class="text-lg font-bold text-green-700 mb-2">Jumlah Kantin</h4>
            <p class="text-4xl font-extrabold text-green-800">{{ kantin_list|length }}</p>
        </div>
        <div class="bg-yellow-50 p-6 rounded-lg shadow-md text-center">
            <h4 class="text-lg font-bold text-yellow-700 mb-2">Total Pesanan</h4>
            <p class="text-4xl font-extrabold text-yellow-800">{{ orders|length }}</p>
        </div>
    </div>

    <h3 class="text-2xl font-semibold text-gray-800 mb-6">Daftar Pesanan Terbaru (Semua Kantin)</h3>
    {% if orders %}
    <div class="overflow-x-auto bg-white rounded-lg shadow-md">
        <table class="min-w-full leading-normal">
            <thead>
                <tr>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID Pesanan</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Pengguna</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Total Harga</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tanggal</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{ order.id }}</td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{ order.customer.username }}</td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">Rp {{ "{:,.0f}".format(order.total_price) }}</td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{ order.order_date.strftime('%d-%m-%Y %H:%M') }}</td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{ order.status.capitalize() }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-center text-xl text-gray-500 py-10">Belum ada pesanan.</p>
    {% endif %}

    <div class="mt-10 pt-6 border-t border-gray-200">
        <h3 class="text-2xl font-semibold text-gray-800 mb-6">Manajemen Kantin & Stok</h3>
        <a href="{{ url_for('manage_stock') }}" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
            Kelola Stok Menu
        </a>
        <!-- Admin could also manage Kantin users, etc. -->
    </div>

    {% elif session['role'] == 'kantin' %}
    <h3 class="text-2xl font-bold text-gray-800 mb-6">Dashboard Kantin: <span class="text-green-700">{{ kantin.name if kantin else 'N/A' }}</span></h3>

    <!-- New Order Notification -->
    {% if new_orders_count > 0 %}
    <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative mb-6" role="alert">
        <strong class="font-bold">Pemberitahuan:</strong>
        <span class="block sm:inline">Anda memiliki {{ new_orders_count }} pesanan baru yang menunggu!</span>
        <!-- A button to mark as read could be added here, or just visiting this page marks them as read -->
    </div>
    {% endif %}

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
        <div class="bg-blue-50 p-6 rounded-lg shadow-md text-center">
            <h4 class="text-lg font-bold text-blue-700 mb-2">Pendapatan Kantin</h4>
            <p class="text-4xl font-extrabold text-blue-800">Rp {{ "{:,.0f}".format(kantin_revenue) }}</p>
        </div>
        <div class="bg-green-50 p-6 rounded-lg shadow-md text-center">
            <h4 class="text-lg font-bold text-green-700 mb-2">Jumlah Menu</h4>
            <p class="text-4xl font-extrabold text-green-800">{{ menus|length }}</p>
        </div>
        <div class="bg-yellow-50 p-6 rounded-lg shadow-md text-center">
            <h4 class="text-lg font-bold text-yellow-700 mb-2">Total Item Terjual</h4>
            <p class="text-4xl font-extrabold text-yellow-800">{{ total_items_sold }}</p>
        </div>
    </div>

    <h3 class="text-2xl font-semibold text-gray-800 mb-6">Daftar Pesanan Masuk (Kantin Anda)</h3>
    {% if kantin_order_items %}
    <div class="overflow-x-auto bg-white rounded-lg shadow-md">
        <table class="min-w-full leading-normal">
            <thead>
                <tr>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID Pesanan</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Menu</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Jumlah</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Harga Satuan</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Subtotal Item</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tanggal Pesanan</th>
                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status Pesanan</th>
                </tr>
            </thead>
            <tbody>
                {% for item, order in kantin_order_items %}
                <tr>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{ order.id }}</td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{ item.menu.name }}</td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{ item.quantity }}</td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">Rp {{ "{:,.0f}".format(item.price) }}</td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">Rp {{ "{:,.0f}".format(item.price * item.quantity) }}</td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{ order.order_date.strftime('%d-%m-%Y %H:%M') }}</td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">{{ order.status.capitalize() }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-center text-xl text-gray-500 py-10">Belum ada pesanan untuk kantin Anda.</p>
    {% endif %}

    <div class="mt-10 pt-6 border-t border-gray-200 flex flex-col md:flex-row gap-4">
        <a href="{{ url_for('manage_stock') }}" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 text-center">
            Kelola Stok Menu
        </a>
        <a href="{{ url_for('manage_kantin_menus') }}" class="inline-block bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 text-center">
            Manajemen Menu Kantin Anda
        </a>
    </div>

    {% endif %}
</section>
{% endblock %}
